<div class="student-form-container">
  <form [formGroup]="studentForm" class="student-form">
    
    <!-- Step Progress Indicator -->
    <div class="step-indicator">
      <div class="step" 
           [class.active]="currentStep === STEP_PERSONAL"
           [class.completed]="isStepCompleted(STEP_PERSONAL)"
           (click)="goToStep(STEP_PERSONAL)">
        <div class="step-icon">
          <i class="fa-solid fa-user"></i>
        </div>
        <span class="step-label">Personal Info</span>
      </div>

      <div class="step-line" [class.completed]="currentStep > STEP_PERSONAL"></div>

      <div class="step"
           [class.active]="currentStep === STEP_ACCOUNT"
           [class.completed]="isStepCompleted(STEP_ACCOUNT)"
           (click)="goToStep(STEP_ACCOUNT)">
        <div class="step-icon">
          <i class="fa-solid fa-id-card"></i>
        </div>
        <span class="step-label">Account Setup</span>
      </div>

      <div class="step-line" [class.completed]="currentStep > STEP_ACCOUNT"></div>

      <div class="step"
           [class.active]="currentStep === STEP_LOCATION"
           [class.completed]="isStepCompleted(STEP_LOCATION)"
           (click)="goToStep(STEP_LOCATION)">
        <div class="step-icon">
          <i class="fa-solid fa-location-dot"></i>
        </div>
        <span class="step-label">Location Info</span>
      </div>
    </div>

    <!-- Step 1: Personal Information -->
    @if (currentStep === STEP_PERSONAL) {
      <div class="form-step">
        <h3 class="step-title">Personal Information</h3>

        <!-- Tenant Selection (SUPER_ADMIN only) -->
        @if (showTenantDropdown) {
          <div class="form-group">
            <label for="tenant_id">Tenant <span class="required">*</span></label>
            <select
              id="tenant_id"
              class="form-control"
              formControlName="tenant_id"
              [disabled]="isViewMode"
              [class.invalid]="studentForm.get('tenant_id')?.invalid && studentForm.get('tenant_id')?.touched"
            >
              <option value="">{{ tenants && tenants.length > 0 ? 'Select Tenant' : 'Loading tenants...' }}</option>
              @for (tenant of tenants; track tenant.tenant_id) {
                <option [value]="tenant.tenant_id">{{ tenant.tenant_name }}</option>
              }
            </select>
            @if (studentForm.get('tenant_id')?.invalid && studentForm.get('tenant_id')?.touched) {
              <div class="error-message">{{ getErrorMessage('tenant_id') }}</div>
            }
            @if (tenants && tenants.length === 0) {
              <small class="text-muted">No tenants available. Please contact administrator.</small>
            }
          </div>
        }

        <div class="form-row">
          <div class="form-group">
            <label for="first_name">First Name <span class="required">*</span></label>
            <input
              type="text"
              id="first_name"
              class="form-control"
              formControlName="first_name"
              placeholder="Enter First Name"
              [disabled]="isViewMode"
              [class.invalid]="studentForm.get('first_name')?.invalid && studentForm.get('first_name')?.touched"
            />
            @if (studentForm.get('first_name')?.invalid && studentForm.get('first_name')?.touched) {
              <div class="error-message">{{ getErrorMessage('first_name') }}</div>
            }
          </div>

          <div class="form-group">
            <label for="last_name">Last Name <span class="required">*</span></label>
            <input
              type="text"
              id="last_name"
              class="form-control"
              formControlName="last_name"
              placeholder="Enter Last Name"
              [disabled]="isViewMode"
              [class.invalid]="studentForm.get('last_name')?.invalid && studentForm.get('last_name')?.touched"
            />
            @if (studentForm.get('last_name')?.invalid && studentForm.get('last_name')?.touched) {
              <div class="error-message">{{ getErrorMessage('last_name') }}</div>
            }
          </div>
        </div>

        <div class="form-group">
          <label for="middle_name">Middle Name</label>
          <input
            type="text"
            id="middle_name"
            class="form-control"
            formControlName="middle_name"
            placeholder="Enter Middle Name (Optional)"
            [disabled]="isViewMode"
          />
        </div>

        <div class="form-group">
          <label for="date_of_birth">DOB</label>
          <input
            type="date"
            id="date_of_birth"
            class="form-control"
            formControlName="date_of_birth"
            placeholder="DD/MM/YYYY"
            [disabled]="isViewMode"
          />
        </div>

        <div class="form-group">
          <label>Gender</label>
          <div class="radio-group">
            <label class="radio-label">
              <input
                type="radio"
                formControlName="gender"
                value="MALE"
                [disabled]="isViewMode"
              />
              <span>Male</span>
            </label>
            <label class="radio-label">
              <input
                type="radio"
                formControlName="gender"
                value="FEMALE"
                [disabled]="isViewMode"
              />
              <span>Female</span>
            </label>
          </div>
        </div>
      </div>
    }

    <!-- Step 2: Account Setup -->
    @if (currentStep === STEP_ACCOUNT) {
      <div class="form-step">
        <h3 class="step-title">Account Setup</h3>

        <!-- Tenant Selection (SUPER_ADMIN only) -->
        @if (showTenantDropdown) {
          <div class="form-group">
            <label for="tenant_id_step2">Tenant <span class="required">*</span></label>
            <select
              id="tenant_id_step2"
              class="form-control"
              formControlName="tenant_id"
              [disabled]="isViewMode"
              [class.invalid]="studentForm.get('tenant_id')?.invalid && studentForm.get('tenant_id')?.touched"
            >
              <option value="">{{ tenants && tenants.length > 0 ? 'Select Tenant' : 'Loading tenants...' }}</option>
              @for (tenant of tenants; track tenant.tenant_id) {
                <option [value]="tenant.tenant_id">{{ tenant.tenant_name }}</option>
              }
            </select>
            @if (studentForm.get('tenant_id')?.invalid && studentForm.get('tenant_id')?.touched) {
              <div class="error-message">{{ getErrorMessage('tenant_id') }}</div>
            }
            @if (tenants && tenants.length === 0) {
              <small class="text-muted">No tenants available. Please contact administrator.</small>
            }
          </div>
        }

        <div class="form-group">
          <label for="username">Username <span class="required">*</span></label>
          <input
            type="text"
            id="username"
            class="form-control"
            formControlName="username"
            placeholder="Enter Username"
            [disabled]="isViewMode"
            [class.invalid]="studentForm.get('username')?.invalid && studentForm.get('username')?.touched"
          />
          @if (studentForm.get('username')?.invalid && studentForm.get('username')?.touched) {
            <div class="error-message">{{ getErrorMessage('username') }}</div>
          }
        </div>

        <!-- Email Addresses -->
        <div class="form-group">
          <div class="contact-header">
            <label>Email Address <span class="required">*</span></label>
            @if (!isViewMode) {
              <button type="button" class="btn-add" (click)="addEmailAddress()">
                + Add More
              </button>
            }
          </div>

          <div formArrayName="emailAddresses" class="contact-list">
            @for (email of emailAddresses.controls; track $index) {
              <div [formGroupName]="$index" class="contact-item">
                <input
                  type="email"
                  class="form-control"
                  formControlName="email_address"
                  placeholder="Enter Email Address"
                  [disabled]="isViewMode"
                  [class.invalid]="email.get('email_address')?.invalid && email.get('email_address')?.touched"
                />
                @if (email.get('email_address')?.invalid && email.get('email_address')?.touched) {
                  <div class="error-message">{{ getEmailErrorMessage($index) }}</div>
                }
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    formControlName="is_primary"
                    (change)="togglePrimaryEmail($index)"
                    [disabled]="isViewMode"
                  />
                  <span>Primary</span>
                </label>
                @if (!isViewMode && emailAddresses.length > 1) {
                  <button 
                    type="button" 
                    class="btn-remove-contact" 
                    (click)="removeEmailAddress($index)"
                    title="Remove email">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                      <path d="M4 6h8v6c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V6zm2-3h4l1 1h2v1H3V4h2l1-1z"/>
                    </svg>
                    <span class="sr-only">Remove</span>
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <!-- Phone Numbers -->
        <div class="form-group">
          <div class="contact-header">
            <label>Phone Number <span class="required">*</span></label>
            @if (!isViewMode) {
              <button type="button" class="btn-add" (click)="addPhoneNumber()">
                + Add More
              </button>
            }
          </div>

          <div formArrayName="phoneNumbers" class="contact-list">
            @for (phone of phoneNumbers.controls; track $index) {
              <div [formGroupName]="$index" class="contact-item phone-item">
                <div class="phone-input-group">
                  <select 
                    class="form-control dial-code" 
                    formControlName="dial_code"
                    [disabled]="isViewMode"
                    [class.invalid]="phone.get('dial_code')?.invalid && phone.get('dial_code')?.touched">
                    <option value="+1">+1</option>
                    <option value="+44">+44</option>
                    <option value="+91">+91</option>
                    <option value="+61">+61</option>
                    <option value="+49">+49</option>
                    <option value="+33">+33</option>
                    <option value="+81">+81</option>
                    <option value="+86">+86</option>
                    <option value="+92">+92</option>
                  </select>
                  <input
                    type="tel"
                    class="form-control phone-number"
                    formControlName="phone_number"
                    placeholder="(305) 760-1379"
                    [disabled]="isViewMode"
                    [class.invalid]="phone.get('phone_number')?.invalid && phone.get('phone_number')?.touched"
                  />
                </div>
                @if (phone.get('dial_code')?.invalid && phone.get('dial_code')?.touched) {
                  <div class="error-message">{{ getPhoneErrorMessage($index, 'dial_code') }}</div>
                }
                @if (phone.get('phone_number')?.invalid && phone.get('phone_number')?.touched) {
                  <div class="error-message">{{ getPhoneErrorMessage($index, 'phone_number') }}</div>
                }
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    formControlName="is_primary"
                    (change)="togglePrimaryPhone($index)"
                    [disabled]="isViewMode"
                  />
                  <span>Primary</span>
                </label>
                @if (!isViewMode && phoneNumbers.length > 1) {
                  <button 
                    type="button" 
                    class="btn-remove-contact" 
                    (click)="removePhoneNumber($index)"
                    title="Remove phone">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                      <path d="M4 6h8v6c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V6zm2-3h4l1 1h2v1H3V4h2l1-1z"/>
                    </svg>
                    <span class="sr-only">Remove</span>
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <div class="form-group">
          <label for="password">Password @if (!isEditMode) { <span class="required">*</span> }</label>
          <input
            type="password"
            id="password"
            class="form-control"
            formControlName="password"
            [placeholder]="isEditMode ? 'Leave blank to keep current password' : 'Enter Password'"
            [disabled]="isViewMode"
          />
          @if (studentForm.get('password')?.invalid && studentForm.get('password')?.touched) {
            <div class="error-message">{{ getErrorMessage('password') }}</div>
          }
        </div>
      </div>
    }

    <!-- Step 3: Location Information -->
    @if (currentStep === STEP_LOCATION) {
      <div class="form-step">
        <h3 class="step-title">Location Information</h3>

        <div class="form-group">
          <label for="country_id">Country <span class="required">*</span></label>
          <select
            id="country_id"
            class="form-control"
            formControlName="country_id"
            (change)="onCountryChange($event)"
            [disabled]="isViewMode"
          >
            <option value="">Enter Or Select City</option>
            @for (country of countries; track country.country_id) {
              <option [value]="country.country_id">{{ country.name }}</option>
            }
          </select>
          @if (studentForm.get('country_id')?.invalid && studentForm.get('country_id')?.touched) {
            <div class="error-message">{{ getErrorMessage('country_id') }}</div>
          }
        </div>

        <div class="form-group">
          <label for="state_id">State/Province <span class="optional">(optional)</span></label>
          <select
            id="state_id"
            class="form-control"
            formControlName="state_id"
            (change)="onStateChange($event)"
            [disabled]="isViewMode || !studentForm.get('country_id')?.value"
          >
            <option value="">Enter Or Select State</option>
            @for (state of states; track state.state_id) {
              <option [value]="state.state_id">{{ state.name }}</option>
            }
          </select>
          @if (studentForm.get('state_id')?.invalid && studentForm.get('state_id')?.touched) {
            <div class="error-message">{{ getErrorMessage('state_id') }}</div>
          }
        </div>

        <div class="form-group">
          <label for="city_id">City <span class="optional">(optional)</span></label>
          <select
            id="city_id"
            class="form-control"
            formControlName="city_id"
            [disabled]="isViewMode || !studentForm.get('country_id')?.value"
          >
            <option value="">Enter Or Select City</option>
            @for (city of cities; track city.city_id) {
              <option [value]="city.city_id">{{ city.name }}</option>
            }
          </select>
          @if (studentForm.get('city_id')?.invalid && studentForm.get('city_id')?.touched) {
            <div class="error-message">{{ getErrorMessage('city_id') }}</div>
          }
        </div>

        <div class="form-group">
          <label for="zip_code">Zip/Postal Code <span class="optional">(optional)</span></label>
          <input
            type="text"
            id="zip_code"
            class="form-control"
            formControlName="zip_code"
            placeholder="Enter Or Select City"
            [disabled]="isViewMode"
          />
        </div>

        <div class="form-group">
          <label for="address">Address <span class="optional">(optional)</span></label>
          <textarea
            id="address"
            class="form-control"
            formControlName="address"
            placeholder="Write Student's Address"
            rows="4"
            [disabled]="isViewMode"
          ></textarea>
        </div>
      </div>
    }
  </form>
</div>
