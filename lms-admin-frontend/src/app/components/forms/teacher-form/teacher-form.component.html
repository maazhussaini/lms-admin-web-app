<div class="teacher-form-container">
  <form class="teacher-form">
    
    <!-- Step Progress Indicator -->
    <div class="step-indicator">
      <div class="step" 
           [class.active]="currentStep === STEP_PERSONAL"
           [class.completed]="isStepCompleted(STEP_PERSONAL)"
           (click)="goToStep(STEP_PERSONAL)">
        <div class="step-icon">
          <i class="fa-solid fa-user"></i>
        </div>
        <span class="step-label">Personal Info</span>
      </div>

      <div class="step-line" [class.completed]="currentStep > STEP_PERSONAL"></div>

      <div class="step"
           [class.active]="currentStep === STEP_ACCOUNT"
           [class.completed]="isStepCompleted(STEP_ACCOUNT)"
           (click)="goToStep(STEP_ACCOUNT)">
        <div class="step-icon">
          <i class="fa-solid fa-id-card"></i>
        </div>
        <span class="step-label">Account Setup</span>
      </div>

      <div class="step-line" [class.completed]="currentStep > STEP_ACCOUNT"></div>

      <div class="step"
           [class.active]="currentStep === STEP_LOCATION"
           [class.completed]="isStepCompleted(STEP_LOCATION)"
           (click)="goToStep(STEP_LOCATION)">
        <div class="step-icon">
          <i class="fa-solid fa-location-dot"></i>
        </div>
        <span class="step-label">Location Info</span>
      </div>

      <div class="step-line" [class.completed]="currentStep > STEP_LOCATION"></div>

      <div class="step"
           [class.active]="currentStep === STEP_COURSE"
           [class.completed]="isStepCompleted(STEP_COURSE)"
           (click)="goToStep(STEP_COURSE)">
        <div class="step-icon">
          <i class="fa-solid fa-book"></i>
        </div>
        <span class="step-label">Course Info</span>
      </div>
    </div>

    <!-- Step 1: Personal Information -->
    @if (currentStep === STEP_PERSONAL) {
      <div class="form-step">
        <h3 class="step-title">Personal Information</h3>
        
        <!-- Tenant Selection (SUPER_ADMIN only) -->
        @if (showTenantDropdown) {
          <div class="form-group">
            <label for="tenant_id" class="form-label">Tenant <span class="required">*</span></label>
            <select
              id="tenant_id"
              name="tenant_id"
              class="form-input"
              [(ngModel)]="formData.tenant_id"
              [disabled]="isViewMode"
            >
              <option value="">{{ tenants && tenants.length > 0 ? 'Select Tenant' : 'Loading tenants...' }}</option>
              @for (tenant of tenants; track tenant.tenant_id) {
                <option [value]="tenant.tenant_id">{{ tenant.tenant_name }}</option>
              }
            </select>
            @if (tenants && tenants.length === 0) {
              <small class="text-muted">No tenants available. Please contact administrator.</small>
            }
          </div>
        }

        <div class="form-row">
          <div class="form-group">
            <label for="first_name" class="form-label">First Name <span class="required">*</span></label>
            <input
              type="text"
              id="first_name"
              name="first_name"
              class="form-input"
              [(ngModel)]="formData.first_name"
              (ngModelChange)="onNameFieldChange()"
              [disabled]="isViewMode"
              required
              placeholder="First name"
            />
          </div>

          <div class="form-group">
            <label for="middle_name" class="form-label">Middle Name <span class="optional">(optional)</span></label>
            <input
              type="text"
              id="middle_name"
              name="middle_name"
              class="form-input"
              [(ngModel)]="formData.middle_name"
              (ngModelChange)="onNameFieldChange()"
              [disabled]="isViewMode"
              placeholder="Middle name"
            />
          </div>

          <div class="form-group">
            <label for="last_name" class="form-label">Last Name <span class="required">*</span></label>
            <input
              type="text"
              id="last_name"
              name="last_name"
              class="form-input"
              [(ngModel)]="formData.last_name"
              (ngModelChange)="onNameFieldChange()"
              [disabled]="isViewMode"
              required
              placeholder="Last name"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="date_of_birth" class="form-label">Date of Birth <span class="optional">(optional)</span></label>
            <input
              type="date"
              id="date_of_birth"
              name="date_of_birth"
              class="form-input"
              [(ngModel)]="formData.date_of_birth"
              [disabled]="isViewMode"
            />
          </div>

          <div class="form-group">
            <label for="age" class="form-label">Age <span class="optional">(optional)</span></label>
            <input
              type="number"
              id="age"
              name="age"
              class="form-input"
              [(ngModel)]="formData.age"
              [disabled]="isViewMode"
              placeholder="Age"
            />
          </div>

          <div class="form-group">
            <label for="gender" class="form-label">Gender <span class="optional">(optional)</span></label>
            <select
              id="gender"
              name="gender"
              class="form-input"
              [(ngModel)]="formData.gender"
              [disabled]="isViewMode"
            >
              <option value="">Select Gender</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="teacher_qualification" class="form-label">Qualification <span class="optional">(optional)</span></label>
            <input
              type="text"
              id="teacher_qualification"
              name="teacher_qualification"
              class="form-input"
              [(ngModel)]="formData.teacher_qualification"
              [disabled]="isViewMode"
              placeholder="Enter qualification (e.g., MS Computer Science)"
            />
          </div>

          <div class="form-group">
            <label for="joining_date" class="form-label">Joining Date <span class="optional">(optional)</span></label>
            <input
              type="date"
              id="joining_date"
              name="joining_date"
              class="form-input"
              [(ngModel)]="formData.joining_date"
              [disabled]="isViewMode"
            />
          </div>
        </div>
      </div>
    }

    <!-- Step 2: Account Setup -->
    @if (currentStep === STEP_ACCOUNT) {
      <div class="form-step">
        <h3 class="step-title">Account Setup</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="username" class="form-label">Username <span class="required">*</span></label>
            <input
              type="text"
              id="username"
              name="username"
              class="form-input"
              [(ngModel)]="formData.username"
              (ngModelChange)="onFormFieldChange()"
              [disabled]="isViewMode || isEditMode"
              required
              placeholder="Enter username"
            />
          </div>

          @if (!isEditMode) {
            <div class="form-group">
              <label for="password" class="form-label">Password <span class="required">*</span></label>
              <input
                type="password"
                id="password"
                name="password"
                class="form-input"
                [(ngModel)]="formData.password"
                (ngModelChange)="onFormFieldChange()"
                [disabled]="isViewMode"
                required
                placeholder="Enter password"
              />
              <small class="form-help-text">Must contain uppercase letter and special character</small>
            </div>
          }
        </div>

        <!-- Email Addresses Section -->
        <div class="contact-section">
          <div class="contact-header">
            <label class="form-label">Email Address <span class="required">*</span></label>
            @if (!isViewMode) {
              <button type="button" class="btn-add-more" (click)="addEmailAddress()">
                <i class="fa-solid fa-plus"></i> Add More
              </button>
            }
          </div>

          <div class="contact-list">
            @for (email of emailAddresses; track $index) {
              <div class="contact-item-wrapper">
                <div class="contact-item email-item">
                  <input
                    type="email"
                    class="form-input email-input"
                    [(ngModel)]="email.email_address"
                    [name]="'email_' + $index"
                    placeholder="Enter Email Address"
                    [disabled]="isViewMode"
                    required
                  />
                  
                  <label class="checkbox-label-inline">
                    <input
                      type="checkbox"
                      [(ngModel)]="email.is_primary"
                      [name]="'email_primary_' + $index"
                      (change)="onEmailPrimaryChange($index)"
                      [disabled]="isViewMode"
                    />
                    <span>Primary</span>
                  </label>
                </div>

                @if (!isViewMode && emailAddresses.length > 1) {
                  <button 
                    type="button"
                    class="btn-remove-contact" 
                    (click)="removeEmailAddress($index)"
                    title="Remove email">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <!-- Phone Numbers Section -->
        <div class="contact-section">
          <div class="contact-header">
            <label class="form-label">Phone Number <span class="required">*</span></label>
            @if (!isViewMode) {
              <button type="button" class="btn-add-more" (click)="addPhoneNumber()">
                <i class="fa-solid fa-plus"></i> Add More
              </button>
            }
          </div>

          <div class="contact-list">
            @for (phone of phoneNumbers; track $index) {
              <div class="contact-item-wrapper">
                <div class="contact-item phone-item">
                  <input
                    type="tel"
                    class="form-input phone-input"
                    [(ngModel)]="phone.phone_number"
                    [name]="'phone_' + $index"
                    placeholder="+92-3001234567"
                    [disabled]="isViewMode"
                  />
                  
                  <label class="checkbox-label-inline">
                    <input
                      type="checkbox"
                      [(ngModel)]="phone.is_primary"
                      [name]="'phone_primary_' + $index"
                      (change)="onPhonePrimaryChange($index)"
                      [disabled]="isViewMode"
                    />
                    <span>Primary</span>
                  </label>
                </div>

                @if (!isViewMode && phoneNumbers.length > 1) {
                  <button 
                    type="button"
                    class="btn-remove-contact" 
                    (click)="removePhoneNumber($index)"
                    title="Remove phone">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                }
              </div>
            }
          </div>
        </div>

      </div>
    }

    <!-- Step 3: Location Information -->
    @if (currentStep === STEP_LOCATION) {
      <div class="form-step">
        <h3 class="step-title">Location Information</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label for="country_id" class="form-label">Country <span class="optional">(optional)</span></label>
            <select
              id="country_id"
              name="country_id"
              class="form-input"
              [(ngModel)]="formData.country_id"
              (ngModelChange)="onCountryChange()"
              [disabled]="isViewMode || isLoadingCountries"
            >
              <option [value]="null">Select Country</option>
              <option *ngFor="let country of countries" [value]="country.country_id">
                {{ country.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="state_id" class="form-label">State <span class="optional">(optional)</span></label>
            <select
              id="state_id"
              name="state_id"
              class="form-input"
              [(ngModel)]="formData.state_id"
              (ngModelChange)="onStateChange()"
              [disabled]="isViewMode || !formData.country_id || isLoadingStates"
            >
              <option [value]="null">Select State</option>
              <option *ngFor="let state of states" [value]="state.state_id">
                {{ state.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="city_id" class="form-label">City <span class="optional">(optional)</span></label>
            <select
              id="city_id"
              name="city_id"
              class="form-input"
              [(ngModel)]="formData.city_id"
              [disabled]="isViewMode || !formData.state_id || isLoadingCities"
            >
              <option [value]="null">Select City</option>
              <option *ngFor="let city of cities" [value]="city.city_id">
                {{ city.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="address" class="form-label">Address <span class="optional">(optional)</span></label>
          <textarea
            id="address"
            name="address"
            class="form-input"
            rows="3"
            [(ngModel)]="formData.address"
            [disabled]="isViewMode"
            placeholder="Enter complete address"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="zip_code" class="form-label">Zip Code <span class="optional">(optional)</span></label>
          <input
            type="text"
            id="zip_code"
            name="zip_code"
            class="form-input"
            [(ngModel)]="formData.zip_code"
            [disabled]="isViewMode"
            placeholder="Enter zip code"
          />
        </div>

      </div>
    }

    <!-- Step 4: Course Information -->
    @if (currentStep === STEP_COURSE) {
      <div class="form-step">
        <h3 class="step-title">Course Assignments</h3>
        
        <div class="form-group">
          <label class="form-label">Assign Courses <span class="optional">(optional)</span></label>
          <p class="form-help-text">Select one or more courses to assign to this teacher.</p>
          
          <div class="course-selection-container">
            @if (isLoadingCourses) {
              <div class="loading-state">
                <i class="fa-solid fa-spinner fa-spin"></i> Loading courses...
              </div>
            } @else if (courses && courses.length > 0) {
              <!-- Course Selection Dropdown -->
              <div class="course-selector">
                <select 
                  class="form-input"
                  [disabled]="isViewMode"
                  (change)="onCourseSelect($any($event.target).value)">
                  <option value="">Select a course to assign</option>
                  @for (course of courses; track course.course_id) {
                    @if (!isCourseSelected(course.course_id)) {
                      <option [value]="course.course_id">
                        {{ course.course_name }} - {{ course.course_status }}
                      </option>
                    }
                  }
                </select>
              </div>

              <!-- Assigned Courses List -->
              @if (selectedCourseIds.length > 0) {
                <div class="assigned-courses-section">
                  <h4 class="section-subtitle">Assigned Courses</h4>
                  <div class="assigned-courses-list">
                    @for (courseId of selectedCourseIds; track courseId; let index = $index) {
                      @if (getCourseById(courseId); as course) {
                        <div class="assigned-course-item">
                          <div class="course-number">{{ index + 1 }}</div>
                          <div class="course-details">
                            <div class="course-title">{{ course.course_name }}</div>
                            @if (course.course_description) {
                              <div class="course-subtitle">{{ course.course_description }}</div>
                            }
                          </div>
                          <div class="course-badge" [class]="'badge-' + course.course_status?.toLowerCase()">
                            {{ course.course_status }}
                          </div>
                          @if (!isViewMode) {
                            <button 
                              type="button"
                              class="btn-remove-course"
                              (click)="removeCourse(courseId)"
                              title="Remove course">
                              <i class="fa-solid fa-xmark"></i>
                            </button>
                          }
                        </div>
                      }
                    }
                  </div>
                </div>
              } @else {
                <div class="empty-message">
                  <i class="fa-solid fa-info-circle"></i>
                  <span>No courses assigned yet. Select courses from the dropdown above.</span>
                </div>
              }
            } @else {
              <div class="empty-state">
                <i class="fa-solid fa-book"></i>
                <p>No courses available for assignment.</p>
              </div>
            }
          </div>
        </div>

      </div>
    }
  </form>
</div>
