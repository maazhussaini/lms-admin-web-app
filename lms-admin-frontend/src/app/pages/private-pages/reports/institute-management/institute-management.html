<div class="institute-management-container">
  <!-- Standard Screen Toolbar -->
  <div class="screen-toolbar">
    <div class="toolbar-left">
      <div class="institute-search">
        <i class="search-icon ic-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search institutes..." 
          [(ngModel)]="searchTerm"
          (input)="onSearch()">
      </div>
    </div>
    
    <div class="toolbar-center">
      <span>Showing</span>
      <select 
        class="showing-select" 
        [(ngModel)]="itemsPerPage" 
        (ngModelChange)="onItemsPerPageChanged($event)">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="toolbar-right">
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilterPopup($event)">
          <i class="ic-filter"></i>
          Filter
        </button>
        <!-- Filter Popup -->
        <div class="filter-popup" [class.active]="showFilterPopup">
          <div class="filter-popup-header">
            <h3>Filters</h3>
          </div>
          <div class="filter-popup-body">
            <p class="no-filters-text">No additional filters available</p>
          </div>
          <div class="filter-popup-footer">
            <button class="btn-secondary" (click)="resetAllFilters()">Reset All</button>
            <button class="btn-primary" (click)="applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <button class="add-btn" (click)="openAddOffcanvas()">
        <i class="ic-plus"></i>
        Add Institute
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedInstitutes.length > 0) {
    <div class="bulk-actions-bar">
      <div class="bulk-info">
        <span class="selection-count">{{selectedInstitutes.length}} items selected</span>
        <a href="javascript:;" class="select-all-link" (click)="selectAll()">
          Select all {{totalInstitutes}}
        </a>
      </div>
      <div class="bulk-actions">
        <button class="bulk-action-btn delete-btn" (click)="bulkDelete()">
          <i class="ic-trash"></i>
          Delete
        </button>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (isLoadingInstitutes) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading institutes...</p>
    </div>
  }

  <!-- Error State -->
  @if (instituteLoadError && !isLoadingInstitutes) {
    <div class="error-container">
      <p class="error-message">{{ instituteLoadError }}</p>
      <button class="retry-btn" (click)="loadInstitutes()">Retry</button>
    </div>
  }

  <!-- Institutes Table -->
  @if (!isLoadingInstitutes && !instituteLoadError) {
    <div class="institutes-table-container">
      <table class="institutes-table">
        <thead>
          <tr>
            <th class="checkbox-col">
              <input 
                type="checkbox" 
                [checked]="selectedInstitutes.length === paginatedInstitutes.length && paginatedInstitutes.length > 0"
                (change)="selectAll()">
            </th>
            <th>ID</th>
            <th>Institute Name</th>
            <th>Tenant</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @if (paginatedInstitutes.length === 0) {
            <tr>
              <td colspan="7" class="no-data">
                No institutes found
              </td>
            </tr>
          }
          @for (institute of paginatedInstitutes; track institute.institute_id) {
            <tr>
              <td class="checkbox-col">
                <input 
                  type="checkbox" 
                  [checked]="isInstituteSelected(institute.institute_id)"
                  (change)="toggleInstituteSelection(institute.institute_id)">
              </td>
              <td>{{ institute.institute_id }}</td>
              <td>
                <div class="institute-name">{{ institute.institute_name }}</div>
              </td>
              <td>{{ institute.tenant_name || 'N/A' }}</td>
              <td>
                <span class="status-badge" [class.active]="institute.is_active" [class.inactive]="!institute.is_active">
                  {{ institute.is_active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>{{ institute.created_at | date:'short' }}</td>
              <td class="actions-col">
                <div class="crud-menu-container">
                  <button class="crud-menu-btn" (click)="toggleMenu($event, institute.institute_id)">
                    <i class="ic-more-vertical"></i>
                  </button>
                  @if (isMenuActive(institute.institute_id)) {
                    <div class="crud-menu-dropdown">
                      <button class="crud-menu-item" (click)="openViewOffcanvas(institute.institute_id, $event)">
                        <i class="ic-eye"></i>
                        View
                      </button>
                      <button class="crud-menu-item" (click)="openEditOffcanvas(institute.institute_id, $event)">
                        <i class="ic-edit"></i>
                        Edit
                      </button>
                      <button class="crud-menu-item delete" (click)="handleDelete(institute.institute_id, $event)">
                        <i class="ic-trash"></i>
                        Delete
                      </button>
                    </div>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <app-paginator
      [currentPage]="currentPage"
      [totalItems]="totalInstitutes"
      [itemsPerPage]="itemsPerPage"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  }
</div>

<!-- Off-Canvas Wrapper for Add/Edit/View Institute -->
<app-off-canvas-wrapper 
  [isOpen]="showAddInstituteOffcanvas" 
  [title]="isViewMode ? 'View Institute' : (isEditMode ? 'Edit Institute' : 'Add Institute')"
  (closed)="closeOffcanvas()">
  
  @if (isLoadingInstituteDetails) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading institute details...</p>
    </div>
  }

  @if (!isLoadingInstituteDetails) {
    <div class="institute-form">
      <!-- Institute Name Field -->
      <div class="form-group">
        <label for="instituteName" class="form-label">Institute Name</label>
        <input 
          type="text" 
          id="instituteName" 
          class="form-control" 
          placeholder="Enter institute name"
          [(ngModel)]="instituteName"
          [disabled]="isViewMode">
      </div>

      @if (isViewMode && selectedInstitute) {
        <div class="form-group">
          <label class="form-label">Tenant</label>
          <input 
            type="text" 
            class="form-control" 
            [value]="selectedInstitute.tenant_name || 'N/A'"
            disabled>
        </div>

        <div class="form-group">
          <label class="form-label">Status</label>
          <input 
            type="text" 
            class="form-control" 
            [value]="selectedInstitute.is_active ? 'Active' : 'Inactive'"
            disabled>
        </div>

        <div class="form-group">
          <label class="form-label">Created At</label>
          <input 
            type="text" 
            class="form-control" 
            [value]="selectedInstitute.created_at | date:'medium'"
            disabled>
        </div>

        <div class="form-group">
          <label class="form-label">Updated At</label>
          <input 
            type="text" 
            class="form-control" 
            [value]="selectedInstitute.updated_at | date:'medium'"
            disabled>
        </div>
      }

      <!-- Form Actions -->
      @if (!isViewMode) {
        <div class="form-actions">
          <button class="btn-secondary" (click)="closeOffcanvas()">Cancel</button>
          <button class="btn-primary" (click)="handleSave()">
            {{ isEditMode ? 'Update' : 'Create' }}
          </button>
        </div>
      }
    </div>
  }
</app-off-canvas-wrapper>
