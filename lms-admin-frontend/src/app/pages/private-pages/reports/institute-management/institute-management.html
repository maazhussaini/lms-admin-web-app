<div class="institute-dashboard">
  <!-- Standard Screen Toolbar -->
  <div class="screen-toolbar">
    <div class="toolbar-left">
      <div class="institute-search">
        <i class="search-icon fas fa-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search here..." 
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange($event)">
      </div>
    </div>
    
    <div class="toolbar-center">
      <span>Showing</span>
      <select 
        class="showing-select" 
        [(ngModel)]="itemsPerPage" 
        (ngModelChange)="onItemsPerPageChanged($event)">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="toolbar-right">
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilterPopup()">
          <i class="fas fa-filter"></i>
          Filter
        </button>
        <!-- Filter Popup - Moved inside container for better positioning -->
        <div class="filter-popup" [class.active]="showFilterPopup">
          <div class="filter-popup-header">
            <h3>Filters</h3>
          </div>
          <div class="filter-popup-body">
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetStatusFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.status">
                <option value="">Select Status</option>
                <option value="ACTIVE">Active</option>
                <option value="INACTIVE">Inactive</option>
              </select>
            </div>
          </div>
          <div class="filter-popup-footer">
            <button class="btn-secondary" (click)="resetAllFilters()">Reset All</button>
            <button class="btn-primary" (click)="applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <button class="add-btn" (click)="openAddInstituteOffcanvas()">
        <i class="fas fa-plus"></i>
        Add Institute
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedInstitutes.length > 0) {
    <div class="bulk-actions-bar mt-3">
      <div class="bulk-info">
        <span class="selection-count">{{selectedInstitutes.length}} items selected</span>
        <a href="javascript:;" class="select-all-link" (click)="selectAll()">
          Select all {{totalInstitutes}}
        </a>
      </div>
      <div class="bulk-actions">
        <button class="btn-success btn-sm" (click)="bulkActivate()" title="Activate Selected">
          <i class="fas fa-check-circle"></i>
          Activate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDeactivate()" title="Deactivate Selected">
          <i class="fas fa-times-circle"></i>
          Deactivate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDelete()" title="Delete Selected">
          <i class="fas fa-trash-alt"></i>
          Delete
        </button>
      </div>
    </div>
  }

  <!-- Main Content -->
  <div class="screen-content mt-5">
    <div class="data-container">
      <div class="data-table-wrapper">
        <div class="table-content">
          @if (isLoadingInstitutes) {
            <div class="table-state loading-state">
              Loading institutes...
            </div>
          } @else if (instituteLoadError) {
            <div class="table-state error-state">
              {{ instituteLoadError }}
            </div>
          } @else if (paginatedInstitutes.length === 0) {
            <div class="table-state empty-state">
              No institutes found.
            </div>
          } @else {
            <table class="institute-table">
              <thead>
                <tr>
                  <th class="checkbox-col">
                    <input 
                      type="checkbox" 
                      class="table-checkbox"
                      [checked]="areAllInstitutesSelected()"
                      (change)="toggleAllInstitutes($event)">
                  </th>
                  <th class="image-col">
                    Image <i class="fas fa-sort"></i>
                  </th>
                  <th class="name-col">
                    Institute Name <i class="fas fa-sort"></i>
                  </th>
                  <th class="count-col">
                    Student Count <i class="fas fa-sort"></i>
                  </th>
                  <th class="created-col">
                    Created At <i class="fas fa-sort"></i>
                  </th>
                  <th class="updated-col">
                    Updated At <i class="fas fa-sort"></i>
                  </th>
                  <th class="status-col">
                    Status
                  </th>
                  <th class="actions-col">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                @for (institute of paginatedInstitutes; track trackByInstituteId($index, institute)) {
                  <tr>
                    <td class="checkbox-col">
                      <input 
                        type="checkbox" 
                        class="table-checkbox"
                        [checked]="isInstituteSelected(institute.institute_id)"
                        (change)="toggleInstituteSelection(institute.institute_id)">
                    </td>
                    <td class="image-col">
                      <div class="institute-logo" [ngClass]="getAvatarClass($index)">
                        @if (institute.logo_url) {
                          <img [src]="institute.logo_url" [alt]="institute.institute_name" class="institute-avatar-img"/>
                        } @else {
                          {{ getInitials(institute.institute_name) }}
                        }
                      </div>
                    </td>
                    <td class="name-col">
                      <div class="institute-name">{{ institute.institute_name }}</div>
                    </td>
                    <td class="count-col">{{ institute.student_count || '04' }}</td>
                    <td class="created-col">{{ institute.created_at | date:'dd-MM-yyyy' }}</td>
                    <td class="updated-col">{{ institute.updated_at | date:'dd-MM-yyyy' }}</td>
                    <td class="status-col">
                      <span class="enum-badge" [ngClass]="'badge-' + (institute.is_active ? 'active' : 'inactive')">
                        {{ institute.is_active ? 'Active' : 'In Active' }}
                      </span>
                    </td>
                    <td class="actions-col">
                      <div class="crud-menu-container">
                        <button 
                          class="crud-menu-trigger" 
                          [class.active]="activeMenuId === institute.institute_id"
                          (click)="toggleMenu(institute.institute_id, $event)">
                          â‹®
                        </button>
                        
                        <!-- Menu dropdown with simplified structure -->
                        <ul 
                          class="crud-menu-dropdown" 
                          [class.show]="activeMenuId === institute.institute_id"
                          [attr.data-menu-id]="institute.institute_id">
                          <li (click)="onViewInstitute(institute); $event.stopPropagation()">
                            <i class="fas fa-eye"></i>
                            <span>View</span>
                          </li>
                          <li (click)="onEditInstitute(institute); $event.stopPropagation()">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                          </li>
                          <li class="danger" (click)="onDeleteInstitute(institute); $event.stopPropagation()">
                            <i class="fas fa-trash-alt"></i>
                            <span>Delete</span>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination Footer -->
  
    <app-paginator
      [currentPage]="currentPage"
      [totalItems]="totalInstitutes"
      [itemsPerPage]="itemsPerPage"
      [maxVisiblePages]="10"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  
</div>

<!-- Add/Edit/View Institute Off-Canvas -->
<app-off-canvas-wrapper
  [isOpen]="showAddInstituteOffcanvas"
  [title]="isViewMode ? 'View Institute' : isEditMode ? 'Edit Institute' : 'Add Institute'">
  
  <div class="institute-form">
    <!-- Institute Name Field -->
    <div class="form-group">
      <label for="instituteName" class="form-label">Institute Name</label>
      <input 
        type="text" 
        id="instituteName" 
        class="form-control" 
        placeholder="Enter institute name"
        [(ngModel)]="instituteName"
        [disabled]="isViewMode">
    </div>

    @if (isViewMode && selectedInstitute) {
      <div class="form-group">
        <label class="form-label">Tenant</label>
        <input 
          type="text" 
          class="form-control" 
          [value]="selectedInstitute.tenant_name || 'N/A'"
          disabled>
      </div>

      <div class="form-group">
        <label class="form-label">Status</label>
        <input 
          type="text" 
          class="form-control" 
          [value]="selectedInstitute.is_active ? 'Active' : 'Inactive'"
          disabled>
      </div>

      <div class="form-group">
        <label class="form-label">Created At</label>
        <input 
          type="text" 
          class="form-control" 
          [value]="selectedInstitute.created_at | date:'medium'"
          disabled>
      </div>

      <div class="form-group">
        <label class="form-label">Updated At</label>
        <input 
          type="text" 
          class="form-control" 
          [value]="selectedInstitute.updated_at | date:'medium'"
          disabled>
      </div>
    }
  </div>
  
  <!-- Footer Buttons -->
  <div slot="footer-buttons" class="footer-button-group">
    @if (!isViewMode) {
      <button 
        class="btn-cancel" 
        (click)="closeAddInstituteOffcanvas()"
        type="button">
        Cancel
      </button>
      <button 
        class="btn-primary" 
        (click)="handleSave()"
        type="button">
        {{ isEditMode ? 'Update' : 'Create' }}
      </button>
    } @else {
      <button 
        class="btn-cancel" 
        (click)="closeAddInstituteOffcanvas()"
        type="button">
        Close
      </button>
    }
  </div>
</app-off-canvas-wrapper>
