<div class="tenant-dashboard">
  <!-- Standard Screen Toolbar -->
  <div class="screen-toolbar">
    <div class="toolbar-left">
      <div class="tenant-search">
        <i class="search-icon fas fa-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search tenants..." 
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange($event)">
      </div>
    </div>
    
    <div class="toolbar-center">
      <span>Showing</span>
      <select 
        class="showing-select" 
        [(ngModel)]="itemsPerPage" 
        (ngModelChange)="onItemsPerPageChanged($event)">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="toolbar-right">
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilterPopup()">
          <i class="fas fa-filter"></i>
          Filter
        </button>
        <!-- Filter Popup - Moved inside container for better positioning -->
        <div class="filter-popup" [class.active]="showFilterPopup">
          <div class="filter-popup-header">
            <h3>Filters</h3>
          </div>
          <div class="filter-popup-body">
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetStatusFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.status">
                <option value="">Select Status</option>
                <option value="Active">Active</option>
                <option value="Pending">Pending</option>
                <option value="Inactive">Inactive</option>
                <option value="In Progress">In Progress</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Start Date</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetStartDateFilter()">Reset</button>
              </div>
              <div class="date-input-container">
                <input type="date" class="filter-date-input" [(ngModel)]="filters.startDate" placeholder="Select start date">
                <i class="icon-calendar date-icon"></i>
              </div>
            </div>
            <div class="filter-group">
              <label class="filter-label">End Date</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetEndDateFilter()">Reset</button>
              </div>
              <div class="date-input-container">
                <input type="date" class="filter-date-input" [(ngModel)]="filters.endDate" placeholder="Select end date">
                <i class="icon-calendar date-icon"></i>
              </div>
            </div>
          </div>
          <div class="filter-popup-footer">
            <button class="btn-secondary" (click)="resetAllFilters()">Reset All</button>
            <button class="btn-primary" (click)="applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <button class="add-btn" (click)="openAddTenantOffcanvas()">
        <i class="fas fa-plus"></i>
        Add Tenant
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedTenants.length > 0) {
    <div class="bulk-actions-bar mt-3">
      <div class="bulk-info">
        <span class="selection-count">{{selectedTenants.length}} items selected</span>
        <a href="javascript:;" class="select-all-link" (click)="selectAll()">
          Select all {{totalTenants}}
        </a>
      </div>
      <div class="bulk-actions">
        <button class="btn-success btn-sm" (click)="bulkActivate()" title="Activate Selected">
          <i class="fas fa-check-circle"></i>
          Activate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDeactivate()" title="Deactivate Selected">
          <i class="fas fa-times-circle"></i>
          Deactivate
        </button>
      </div>
    </div>
  }

  <!-- Main Content -->
  <div class="screen-content mt-5">
    <div class="data-container">
      <div class="data-table-wrapper">
        <div class="table-content">
          @if (isLoadingTenants) {
            <div class="table-state loading-state">
              Loading tenants...
            </div>
          } @else if (tenantLoadError) {
            <div class="table-state error-state">
              {{ tenantLoadError }}
            </div>
          } @else if (paginatedTenants.length === 0) {
            <div class="table-state empty-state">
              No tenants found.
            </div>
          } @else {
            <table class="tenant-table">
              <thead>
                <tr>
                  <th class="checkbox-col">
                    <input 
                      type="checkbox" 
                      class="table-checkbox"
                      [checked]="isAllSelected()"
                      (change)="toggleAllSelection()">
                  </th>
                  <th class="logo-col">
                    Logo <i class="fas fa-sort"></i>
                  </th>
                  <th class="name-col">
                    Tenant Name <i class="fas fa-sort"></i>
                  </th>
                  <!-- <th class="clients-col">
                    Clients <i class="fas fa-sort"></i>
                  </th> -->
                  <th class="phone-col">
                    Phone <i class="fas fa-sort"></i>
                  </th>
                  <th class="email-col">
                    Email <i class="fas fa-sort"></i>
                  </th>
                  <th class="created-col">
                    Created <i class="fas fa-sort"></i>
                  </th>
                  <th class="updated-col">
                    Updated <i class="fas fa-sort"></i>
                  </th>
                  <th class="status-col">
                    Status
                  </th>
                  <th class="actions-col">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                @for (tenant of paginatedTenants; track trackByTenantId($index, tenant)) {
                  <tr>
                    <td class="checkbox-col">
                      <input 
                        type="checkbox" 
                        class="table-checkbox"
                        [checked]="isSelected(tenant.id)"
                        (change)="toggleSelection(tenant.id)">
                    </td>
                    <td class="logo-col">
                      <div class="tenant-logo" [ngClass]="tenant.logoClass">
                        {{ tenant.logoInitial }}
                      </div>
                    </td>
                    <td class="name-col">
                      <div class="tenant-name">{{ tenant.name }}</div>
                    </td>
                    <!-- <td class="clients-col">{{ tenant.clientsCount || 0 }}</td> -->
                    <td class="phone-col">{{ tenant.phone }}</td>
                    <td class="email-col">
                      <div class="tenant-email">{{ tenant.email }}</div>
                    </td>
                    <td class="created-col">{{ tenant.createdAt | date:'dd-MM-yyyy' }}</td>
                    <td class="updated-col">{{ tenant.updatedAt | date:'dd-MM-yyyy' }}</td>
                    <td class="status-col">
                      <span class="enum-badge" [ngClass]="'badge-' + tenant.status.toLowerCase()">
                        {{ tenant.status }}
                      </span>
                    </td>
                    <td class="actions-col">
                      <div class="crud-menu-container">
                        <button 
                          class="crud-menu-trigger" 
                          [class.active]="activeMenuId === tenant.id"
                          (click)="toggleMenu(tenant.id, $event)">
                          ⋮
                        </button>
                        
                        <!-- Menu dropdown with simplified structure -->
                        <ul 
                          class="crud-menu-dropdown" 
                          [class.show]="activeMenuId === tenant.id"
                          [attr.data-menu-id]="tenant.id">
                          <li (click)="onViewTenant(tenant.id)">
                            <i class="fas fa-eye"></i>
                            <span>View</span>
                          </li>
                          <li (click)="onEditTenant(tenant.id)">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                          </li>
                          <li class="danger" (click)="onDeleteTenant(tenant.id)">
                            <i class="fas fa-trash-alt"></i>
                            <span>Delete</span>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination Footer -->
  
    <app-paginator
      [currentPage]="currentPage"
      [totalItems]="totalTenants"
      [itemsPerPage]="itemsPerPage"
      [maxVisiblePages]="10"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  
</div>

<!-- Add/Edit/View Tenant Off-Canvas -->
<app-off-canvas-wrapper
  [isOpen]="showAddTenantOffcanvas"
  [title]="isViewMode ? 'View Tenant Information' : (isEditMode ? 'Edit Tenant' : 'Add Tenant')"
  [saveButtonText]="isEditMode ? 'Update' : 'Save'"
  [showSaveButton]="!isViewMode"
  [canSave]="canSaveTenant"
  [isLoading]="false"
  (close)="closeAddTenantOffcanvas()"
  (submit)="saveTenant()">
  <app-basic-tenant-form 
    [formData]="newTenantData"
    [isViewMode]="isViewMode"
    (formDataChange)="onTenantFormDataChange($event)"
    (validityChange)="onTenantFormValidityChange($event)">
  </app-basic-tenant-form>
</app-off-canvas-wrapper>

<!-- View Tenant Details Modal -->
@if (showViewTenantModal && selectedTenant) {
  <div class="modal-overlay" (click)="closeViewTenantModal()">
    <div class="modal-container tenant-details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <div class="tenant-logo {{selectedTenant.logoClass}}">
            {{ selectedTenant.logoInitial }}
          </div>
          {{ selectedTenant.name }}
        </h2>
        <button class="modal-close-btn" (click)="closeViewTenantModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        @if (isLoadingTenantDetails) {
          <div class="loading-state">Loading tenant details...</div>
        } @else {
          <!-- Basic Information -->
          <div class="detail-section">
            <h3 class="section-title">Basic Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label class="detail-label">Tenant Name</label>
                <div class="detail-value">{{ selectedTenant.name }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Status</label>
                <div class="detail-value">
                  <span class="enum-badge" [ngClass]="'badge-' + selectedTenant.status.toLowerCase()">
                    {{ selectedTenant.status }}
                  </span>
                </div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Domain</label>
                <div class="detail-value">{{ selectedTenant.tenantDomain || '—' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Clients</label>
                <div class="detail-value">{{ selectedTenant.clientsCount }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Created At</label>
                <div class="detail-value">{{ selectedTenant.createdAt | date:'dd MMM yyyy, hh:mm a' }}</div>
              </div>
              <div class="detail-item">
                <label class="detail-label">Updated At</label>
                <div class="detail-value">{{ selectedTenant.updatedAt | date:'dd MMM yyyy, hh:mm a' }}</div>
              </div>
            </div>
          </div>

          <!-- Phone Numbers Section -->
          <div class="detail-section">
            <div class="section-header">
              <h3 class="section-title">Phone Numbers</h3>
              <button class="btn-sm btn-primary" (click)="toggleAddPhoneForm()">
                <i class="fas fa-plus"></i>
                Add Phone
              </button>
            </div>

            @if (showAddPhoneForm) {
              <div class="contact-form">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Dial Code</label>
                    <input type="text" class="form-input" [(ngModel)]="newPhoneNumber.dialCode" placeholder="+92">
                  </div>
                  <div class="form-group flex-2">
                    <label class="form-label">Phone Number</label>
                    <input type="text" class="form-input" [(ngModel)]="newPhoneNumber.phoneNumber" placeholder="3001234567">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" class="form-input" [(ngModel)]="newPhoneNumber.isoCountryCode" placeholder="PK" maxlength="2">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Contact Type</label>
                    <select class="form-input" [(ngModel)]="newPhoneNumber.contactType">
                      <option value="WORK">Work</option>
                      <option value="HOME">Home</option>
                      <option value="MOBILE">Mobile</option>
                      <option value="OTHER">Other</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-checkbox">
                      <input type="checkbox" [(ngModel)]="newPhoneNumber.isPrimary">
                      <span>Set as Primary</span>
                    </label>
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn-secondary btn-sm" (click)="toggleAddPhoneForm()">Cancel</button>
                  <button class="btn-primary btn-sm" (click)="savePhoneNumber()">Save Phone</button>
                </div>
              </div>
            }

            @if (isLoadingContacts) {
              <div class="loading-state-sm">Loading phone numbers...</div>
            } @else if (tenantPhoneNumbers.length === 0) {
              <div class="empty-state-sm">No phone numbers added yet</div>
            } @else {
              <div class="contact-list">
                @for (phone of tenantPhoneNumbers; track phone.id) {
                  <div class="contact-item">
                    <div class="contact-info">
                      <div class="contact-value">
                        {{ phone.dialCode }} {{ phone.phoneNumber }}
                        @if (phone.isPrimary) {
                          <span class="enum-badge badge-primary">Primary</span>
                        }
                      </div>
                      <div class="contact-meta">
                        <span class="contact-type">{{ phone.contactType }}</span>
                        @if (phone.isoCountryCode) {
                          <span class="contact-country">{{ phone.isoCountryCode }}</span>
                        }
                      </div>
                    </div>
                    <div class="contact-actions">
                      @if (!phone.isPrimary) {
                        <button class="btn-icon" (click)="togglePrimaryPhone(phone.id)" title="Set as primary">
                          <i class="fas fa-star"></i>
                        </button>
                      }
                      <button class="btn-icon btn-danger" (click)="deletePhoneNumber(phone.id)" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Email Addresses Section -->
          <div class="detail-section">
            <div class="section-header">
              <h3 class="section-title">Email Addresses</h3>
              <button class="btn-sm btn-primary" (click)="toggleAddEmailForm()">
                <i class="fas fa-plus"></i>
                Add Email
              </button>
            </div>

            @if (showAddEmailForm) {
              <div class="contact-form">
                <div class="form-row">
                  <div class="form-group flex-2">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" [(ngModel)]="newEmailAddress.emailAddress" placeholder="email@example.com">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Contact Type</label>
                    <select class="form-input" [(ngModel)]="newEmailAddress.contactType">
                      <option value="WORK">Work</option>
                      <option value="HOME">Home</option>
                      <option value="OTHER">Other</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-checkbox">
                      <input type="checkbox" [(ngModel)]="newEmailAddress.isPrimary">
                      <span>Set as Primary</span>
                    </label>
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn-secondary btn-sm" (click)="toggleAddEmailForm()">Cancel</button>
                  <button class="btn-primary btn-sm" (click)="saveEmailAddress()">Save Email</button>
                </div>
              </div>
            }

            @if (isLoadingContacts) {
              <div class="loading-state-sm">Loading email addresses...</div>
            } @else if (tenantEmailAddresses.length === 0) {
              <div class="empty-state-sm">No email addresses added yet</div>
            } @else {
              <div class="contact-list">
                @for (email of tenantEmailAddresses; track email.id) {
                  <div class="contact-item">
                    <div class="contact-info">
                      <div class="contact-value">
                        {{ email.emailAddress }}
                        @if (email.isPrimary) {
                          <span class="enum-badge badge-primary">Primary</span>
                        }
                      </div>
                      <div class="contact-meta">
                        <span class="contact-type">{{ email.contactType }}</span>
                      </div>
                    </div>
                    <div class="contact-actions">
                      @if (!email.isPrimary) {
                        <button class="btn-icon" (click)="togglePrimaryEmail(email.id)" title="Set as primary">
                          <i class="fas fa-star"></i>
                        </button>
                      }
                      <button class="btn-icon btn-danger" (click)="deleteEmailAddress(email.id)" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeViewTenantModal()">Close</button>
        <button class="btn-primary" (click)="onEditTenant(selectedTenant.id)">Edit Tenant</button>
      </div>
    </div>
  </div>
}
