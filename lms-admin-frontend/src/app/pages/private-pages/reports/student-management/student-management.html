<div class="student-management-container">
  <!-- Standard Screen Toolbar -->
  <div class="screen-toolbar">
    <div class="toolbar-left">
      <div class="student-search">
        <i class="search-icon ic-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search students..." 
          [(ngModel)]="searchTerm"
          (input)="onSearch()">
      </div>
    </div>
    
    <div class="toolbar-center">
      <span>Showing</span>
      <select 
        class="showing-select" 
        [(ngModel)]="itemsPerPage" 
        (ngModelChange)="onItemsPerPageChanged($event)">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="toolbar-right">
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilterPopup()">
          <i class="ic-filter"></i>
          Filter
        </button>
        <!-- Filter Popup -->
        <div class="filter-popup" [class.active]="showFilterPopup">
          <div class="filter-popup-header">
            <h3>Filters</h3>
          </div>
          <div class="filter-popup-body">
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetStatusFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.status">
                <option value="">All Status</option>
                <option value="ACTIVE">Active</option>
                <option value="INACTIVE">Inactive</option>
                <option value="GRADUATED">Graduated</option>
                <option value="SUSPENDED">Suspended</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Gender</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetGenderFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.gender">
                <option value="">All Genders</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Country</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetCountryFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.countryId">
                <option value="">All Countries</option>
                @for (country of countries; track country.country_id) {
                  <option [value]="country.country_id">{{ country.country_name }}</option>
                }
              </select>
            </div>
          </div>
          <div class="filter-popup-footer">
            <button class="btn-secondary" (click)="resetAllFilters()">Reset All</button>
            <button class="btn-primary" (click)="applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <button class="add-btn" (click)="openAddStudentOffcanvas()">
        <i class="ic-plus"></i>
        Add Student
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedStudents.length > 0) {
    <div class="bulk-actions-bar">
      <div class="bulk-info">
        <span class="selection-count">{{selectedStudents.length}} items selected</span>
        <a href="javascript:;" class="select-all-link" (click)="selectAll()">
          Select all {{totalStudents}}
        </a>
      </div>
      <div class="bulk-actions">
        <button class="btn-success btn-sm" (click)="bulkActivate()" title="Activate Selected">
          <i class="fas fa-check-circle"></i>
          Activate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDeactivate()" title="Deactivate Selected">
          <i class="fas fa-times-circle"></i>
          Deactivate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDelete()" title="Delete Selected">
          <i class="fas fa-trash-alt"></i>
          Delete
        </button>
      </div>
    </div>
  }

  <!-- Students Table -->
  @if (isLoadingStudents) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading students...</p>
    </div>
  } @else if (studentLoadError) {
    <div class="error-state">
      <p>{{ studentLoadError }}</p>
      <button class="btn btn-secondary" (click)="loadStudents()">Retry</button>
    </div>
  } @else {
    <div class="table-container">
      <table class="students-table">
        <thead>
          <tr>
            <th><input type="checkbox" [checked]="areAllStudentsSelected()" (change)="toggleAllStudents($event)"/></th>
            <th>Image</th>
            <th>Student Name</th>
            <th>Username</th>
            <th>Phone No.</th>
            <th>Primary Email</th>
            <th>Enrollments</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (student of paginatedStudents; track student.student_id) {
            <tr>
              <td>
                <input 
                  type="checkbox" 
                  [checked]="isStudentSelected(student.student_id)"
                  (change)="toggleStudentSelection(student.student_id)"
                />
              </td>
              <td>
                <div class="student-avatar" [class]="getAvatarClass($index)">
                  @if (student.profile_picture_url) {
                    <img [src]="student.profile_picture_url" [alt]="student.full_name"/>
                  } @else {
                    <span>{{ getInitials(student.full_name) }}</span>
                  }
                </div>
              </td>
              <td>
                <div class="student-name-cell">
                  <span class="name">{{ student.full_name }}</span>
                  <span class="student-id">{{ student.username }}</span>
                </div>
              </td>
              <td>{{ student.username }}</td>
              <td>{{ student.primary_phone || '-' }}</td>
              <td>{{ student.primary_email || '-' }}</td>
              <td>{{ student.enrollments || 0 }} Courses</td>
              <td>
                <span class="badge" [class]="getStatusBadgeClass(student.student_status)">
                  {{ student.student_status }}
                </span>
              </td>
              <td>
                <div class="crud-menu-container">
                  <button 
                    class="btn-menu"
                    (click)="toggleMenu(student.student_id, $event)"
                    title="More actions">
                    <svg width="4" height="16" viewBox="0 0 4 16" fill="currentColor">
                      <circle cx="2" cy="2" r="2"/>
                      <circle cx="2" cy="8" r="2"/>
                      <circle cx="2" cy="14" r="2"/>
                    </svg>
                  </button>

                  @if (activeMenuId === student.student_id) {
                    <div class="crud-menu">
                      <button class="menu-item" (click)="onViewStudent(student)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M8 3C4.5 3 1.7 5.6 1 8c.7 2.4 3.5 5 7 5s6.3-2.6 7-5c-.7-2.4-3.5-5-7-5zm0 8c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3z"/>
                        </svg>
                        View
                      </button>
                      <button class="menu-item" (click)="onEditStudent(student)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M11.5 1.5l3 3L5 14H2v-3L11.5 1.5z"/>
                        </svg>
                        Edit
                      </button>
                      <button class="menu-item danger" (click)="onDeleteStudent(student)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M5 3V1h6v2h4v2h-1v10H2V5H1V3h4zM6 5v8h1V5H6zm3 0v8h1V5H9z"/>
                        </svg>
                        Delete
                      </button>
                    </div>
                  }
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="9" class="empty-state">
                <p>No students found</p>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    @if (totalPages > 1) {
      <app-paginator
        [currentPage]="currentPage"
        [totalItems]="totalStudents"
        [itemsPerPage]="itemsPerPage"
        (pageChange)="onPageChange($event)"
      ></app-paginator>
    }
  }

  <!-- Off-canvas for Add/Edit/View Student -->
  @if (showAddStudentOffcanvas) {
    <app-off-canvas-wrapper
      [isOpen]="showAddStudentOffcanvas"
      [title]="isViewMode ? 'View Student' : isEditMode ? 'Edit Student' : 'Add Student'"
      (close)="closeAddStudentOffcanvas()">
      
      <app-student-form
        [student]="selectedStudent"
        [isEditMode]="isEditMode"
        [isViewMode]="isViewMode"
        [countries]="countries"
        [states]="states"
        [cities]="cities"
        (formSubmit)="onStudentFormSubmit($event)"
        (formCancel)="closeAddStudentOffcanvas()"
        (countryChange)="onCountryChange($event)"
        (stateChange)="onStateChange($event)"
      ></app-student-form>
    </app-off-canvas-wrapper>
  }
</div>
