<div class="student-dashboard">
  <!-- Standard Screen Toolbar -->
  <div class="screen-toolbar">
    <div class="toolbar-left">
      <div class="student-search">
        <i class="search-icon fas fa-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search students..." 
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange($event)">
      </div>
    </div>
    
    <div class="toolbar-center">
      <span>Showing</span>
      <select 
        class="showing-select" 
        [(ngModel)]="itemsPerPage" 
        (ngModelChange)="onItemsPerPageChanged($event)">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="toolbar-right">
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilterPopup()">
          <i class="fas fa-filter"></i>
          Filter
        </button>
        <!-- Filter Popup - Moved inside container for better positioning -->
        <div class="filter-popup" [class.active]="showFilterPopup">
          <div class="filter-popup-header">
            <h3>Filters</h3>
          </div>
          <div class="filter-popup-body">
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetStatusFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.status">
                <option value="">Select Status</option>
                <option value="ACTIVE">Active</option>
                <option value="INACTIVE">Inactive</option>
                <option value="GRADUATED">Graduated</option>
                <option value="SUSPENDED">Suspended</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Gender</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetGenderFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.gender">
                <option value="">Select Gender</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Country</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetCountryFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.countryId">
                <option value="">Select Country</option>
                @for (country of countries; track country.country_id) {
                  <option [value]="country.country_id">{{ country.country_name }}</option>
                }
              </select>
            </div>
          </div>
          <div class="filter-popup-footer">
            <button class="btn-secondary" (click)="resetAllFilters()">Reset All</button>
            <button class="btn-primary" (click)="applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <button class="add-btn" (click)="openAddStudentOffcanvas()">
        <i class="fas fa-plus"></i>
        Add Student
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedStudents.length > 0) {
    <div class="bulk-actions-bar mt-3">
      <div class="bulk-info">
        <span class="selection-count">{{selectedStudents.length}} items selected</span>
        <a href="javascript:;" class="select-all-link" (click)="selectAll()">
          Select all {{totalStudents}}
        </a>
      </div>
      <div class="bulk-actions">
        <button class="btn-success btn-sm" (click)="bulkActivate()" title="Activate Selected">
          <i class="fas fa-check-circle"></i>
          Activate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDeactivate()" title="Deactivate Selected">
          <i class="fas fa-times-circle"></i>
          Deactivate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDelete()" title="Delete Selected">
          <i class="fas fa-trash-alt"></i>
          Delete
        </button>
      </div>
    </div>
  }

  <!-- Main Content -->
  <div class="screen-content mt-5">
    <div class="data-container">
      <div class="data-table-wrapper">
        <div class="table-content">
          @if (isLoadingStudents) {
            <div class="table-state loading-state">
              Loading students...
            </div>
          } @else if (studentLoadError) {
            <div class="table-state error-state">
              {{ studentLoadError }}
            </div>
          } @else if (paginatedStudents.length === 0) {
            <div class="table-state empty-state">
              No students found.
            </div>
          } @else {
            <table class="student-table">
              <thead>
                <tr>
                  <th class="checkbox-col">
                    <input 
                      type="checkbox" 
                      class="table-checkbox"
                      [checked]="areAllStudentsSelected()"
                      (change)="toggleAllStudents($event)">
                  </th>
                  <th class="image-col">
                    Image <i class="fas fa-sort"></i>
                  </th>
                  <th class="name-col">
                    Student Name <i class="fas fa-sort"></i>
                  </th>
                  <th class="username-col">
                    Username <i class="fas fa-sort"></i>
                  </th>
                  <th class="phone-col">
                    Phone <i class="fas fa-sort"></i>
                  </th>
                  <th class="email-col">
                    Primary Email <i class="fas fa-sort"></i>
                  </th>
                  <th class="enrollments-col">
                    Enrollments <i class="fas fa-sort"></i>
                  </th>
                  <th class="status-col">
                    Status
                  </th>
                  <th class="actions-col">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                @for (student of paginatedStudents; track trackByStudentId($index, student)) {
                  <tr>
                    <td class="checkbox-col">
                      <input 
                        type="checkbox" 
                        class="table-checkbox"
                        [checked]="isStudentSelected(student.student_id)"
                        (change)="toggleStudentSelection(student.student_id)">
                    </td>
                    <td class="image-col">
                      <div class="student-logo" [ngClass]="getAvatarClass($index)">
                        @if (student.profile_picture_url) {
                          <img [src]="student.profile_picture_url" [alt]="student.full_name" class="student-avatar-img"/>
                        } @else {
                          {{ getInitials(student.full_name) }}
                        }
                      </div>
                    </td>
                    <td class="name-col">
                      <div class="student-name">{{ student.full_name }}</div>
                    </td>
                    <td class="username-col">{{ student.username }}</td>
                    <td class="phone-col">{{ student.primary_phone || '—' }}</td>
                    <td class="email-col">
                      <div class="student-email">{{ student.primary_email || '—' }}</div>
                    </td>
                    <td class="enrollments-col">{{ student.enrollments || 0 }} Courses</td>
                    <td class="status-col">
                      <span class="enum-badge" [ngClass]="'badge-' + (student.student_status | lowercase)">
                        {{ student.student_status }}
                      </span>
                    </td>
                    <td class="actions-col">
                      <div class="crud-menu-container">
                        <button 
                          class="crud-menu-trigger" 
                          [class.active]="activeMenuId === student.student_id"
                          (click)="toggleMenu(student.student_id, $event)">
                          ⋮
                        </button>
                        
                        <!-- Menu dropdown with simplified structure -->
                        <ul 
                          class="crud-menu-dropdown" 
                          [class.show]="activeMenuId === student.student_id"
                          [attr.data-menu-id]="student.student_id">
                          <li (click)="onViewStudent(student); $event.stopPropagation()">
                            <i class="fas fa-eye"></i>
                            <span>View</span>
                          </li>
                          <li (click)="onEditStudent(student); $event.stopPropagation()">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                          </li>
                          <li class="danger" (click)="onDeleteStudent(student); $event.stopPropagation()">
                            <i class="fas fa-trash-alt"></i>
                            <span>Delete</span>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination Footer -->
  
    <app-paginator
      [currentPage]="currentPage"
      [totalItems]="totalStudents"
      [itemsPerPage]="itemsPerPage"
      [maxVisiblePages]="10"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  
</div>

<!-- Add/Edit/View Student Off-Canvas -->
<app-off-canvas-wrapper
  [isOpen]="showAddStudentOffcanvas"
  [title]="isViewMode ? 'View Student' : isEditMode ? 'Edit Student' : 'Add Student'"
  (close)="closeAddStudentOffcanvas()">
  
  <app-student-form
    [student]="selectedStudent"
    [isEditMode]="isEditMode"
    [isViewMode]="isViewMode"
    [countries]="countries"
    [states]="states"
    [cities]="cities"
    (formSubmit)="onStudentFormSubmit($event)"
    (formCancel)="closeAddStudentOffcanvas()"
    (countryChange)="onCountryChange($event)"
    (stateChange)="onStateChange($event)"
  ></app-student-form>
</app-off-canvas-wrapper>
