<div class="teacher-dashboard">
  <!-- Standard Screen Toolbar -->
  <div class="screen-toolbar">
    <div class="toolbar-left">
      <div class="teacher-search">
        <i class="search-icon fas fa-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search here..." 
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange($event)">
      </div>
    </div>
    
    <div class="toolbar-center">
      <span>Showing</span>
      <select 
        class="showing-select" 
        [(ngModel)]="itemsPerPage" 
        (ngModelChange)="onItemsPerPageChanged($event)">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="toolbar-right">
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilterPopup()">
          <i class="fas fa-filter"></i>
          Filter
        </button>
        <!-- Filter Popup - Moved inside container for better positioning -->
        <div class="filter-popup" [class.active]="showFilterPopup">
          <div class="filter-popup-header">
            <h3>Filters</h3>
          </div>
          <div class="filter-popup-body">
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetStatusFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.status">
                <option value="">Select Status</option>
                <option value="ACTIVE">Active</option>
                <option value="INACTIVE">Inactive</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Gender</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetGenderFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.gender">
                <option value="">Select Gender</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Country</label>
              <div class="filter-options">
                <button class="filter-option-btn" (click)="resetCountryFilter()">Reset</button>
              </div>
              <select class="filter-select" [(ngModel)]="filters.countryId">
                <option value="">Select Country</option>
                @for (country of countries; track country.country_id) {
                  <option [value]="country.country_id">{{ country.name }}</option>
                }
              </select>
            </div>
          </div>
          <div class="filter-popup-footer">
            <button class="btn-secondary" (click)="resetAllFilters()">Reset All</button>
            <button class="btn-primary" (click)="applyFilters()">Apply</button>
          </div>
        </div>
      </div>
      <button class="add-btn" (click)="openAddTeacherOffcanvas()">
        <i class="fas fa-plus"></i>
        Add Teacher
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedTeachers.length > 0) {
    <div class="bulk-actions-bar mt-3">
      <div class="bulk-info">
        <span class="selection-count">{{selectedTeachers.length}} items selected</span>
        <a href="javascript:;" class="select-all-link" (click)="selectAll()">
          Select all {{totalTeachers}}
        </a>
      </div>
      <div class="bulk-actions">
        <button class="btn-success btn-sm" (click)="bulkActivate()" title="Activate Selected">
          <i class="fas fa-check-circle"></i>
          Activate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDeactivate()" title="Deactivate Selected">
          <i class="fas fa-times-circle"></i>
          Deactivate
        </button>
        <button class="btn-danger btn-sm" (click)="bulkDelete()" title="Delete Selected">
          <i class="fas fa-trash-alt"></i>
          Delete
        </button>
      </div>
    </div>
  }

  <!-- Main Content -->
  <div class="screen-content mt-5">
    <div class="data-container">
      <div class="data-table-wrapper">
        <div class="table-content">
          @if (isLoadingTeachers) {
            <div class="table-state loading-state">
              Loading teachers...
            </div>
          } @else if (teacherLoadError) {
            <div class="table-state error-state">
              {{ teacherLoadError }}
            </div>
          } @else if (paginatedTeachers.length === 0) {
            <div class="table-state empty-state">
              No teachers found.
            </div>
          } @else {
            <table class="teacher-table">
              <thead>
                <tr>
                  <th class="checkbox-col">
                    <input 
                      type="checkbox" 
                      class="table-checkbox"
                      [checked]="areAllTeachersSelected()"
                      (change)="toggleAllTeachers($event)">
                  </th>
                  <th class="image-col">
                    Image <i class="fas fa-sort"></i>
                  </th>
                  <th class="name-col">
                    Teacher Name <i class="fas fa-sort"></i>
                  </th>
                  <th class="username-col">
                    Username <i class="fas fa-sort"></i>
                  </th>
                  <th class="phone-col">
                    Phone <i class="fas fa-sort"></i>
                  </th>
                  <th class="email-col">
                    Primary Email <i class="fas fa-sort"></i>
                  </th>
                  <th class="qualification-col">
                    Qualification <i class="fas fa-sort"></i>
                  </th>
                  <th class="status-col">
                    Status
                  </th>
                  <th class="actions-col">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                @for (teacher of paginatedTeachers; track trackByTeacherId($index, teacher)) {
                  <tr>
                    <td class="checkbox-col">
                      <input 
                        type="checkbox" 
                        class="table-checkbox"
                        [checked]="isTeacherSelected(teacher.teacher_id)"
                        (change)="toggleTeacherSelection(teacher.teacher_id)">
                    </td>
                    <td class="image-col">
                      <div class="teacher-logo" [ngClass]="getAvatarClass($index)">
                        @if (teacher.profile_picture_url) {
                          <img [src]="teacher.profile_picture_url" [alt]="teacher.full_name" class="teacher-avatar-img"/>
                        } @else {
                          {{ getInitials(teacher.full_name) }}
                        }
                      </div>
                    </td>
                    <td class="name-col">
                      <div class="teacher-name">{{ teacher.full_name }}</div>
                    </td>
                    <td class="username-col">{{ teacher.username }}</td>
                    <td class="phone-col">{{ teacher.primary_phone || '—' }}</td>
                    <td class="email-col">
                      <div class="teacher-email">{{ teacher.primary_email || '—' }}</div>
                    </td>
                    <td class="qualification-col">{{ teacher.teacher_qualification || '—' }}</td>
                    <td class="status-col">
                      <span class="enum-badge" [ngClass]="'badge-' + (teacher.is_active ? 'active' : 'inactive')">
                        {{ teacher.is_active ? 'Active' : 'In Active' }}
                      </span>
                    </td>
                    <td class="actions-col">
                      <div class="crud-menu-container">
                        <button 
                          class="crud-menu-trigger" 
                          [class.active]="activeMenuId === teacher.teacher_id"
                          (click)="toggleMenu(teacher.teacher_id, $event)">
                          ⋮
                        </button>
                        
                        <!-- Menu dropdown with simplified structure -->
                        <ul 
                          class="crud-menu-dropdown" 
                          [class.show]="activeMenuId === teacher.teacher_id"
                          [attr.data-menu-id]="teacher.teacher_id">
                          <li (click)="onViewTeacher(teacher); $event.stopPropagation()">
                            <i class="fas fa-eye"></i>
                            <span>View</span>
                          </li>
                          <li (click)="onEditTeacher(teacher); $event.stopPropagation()">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                          </li>
                          <li class="danger" (click)="onDeleteTeacher(teacher); $event.stopPropagation()">
                            <i class="fas fa-trash-alt"></i>
                            <span>Delete</span>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination Footer -->
  
    <app-paginator
      [currentPage]="currentPage"
      [totalItems]="totalTeachers"
      [itemsPerPage]="itemsPerPage"
      [maxVisiblePages]="10"
      (pageChange)="onPageChange($event)">
    </app-paginator>
  
</div>

<!-- Add/Edit/View Teacher Off-Canvas -->
<app-off-canvas-wrapper
  [isOpen]="showAddTeacherOffcanvas"
  [title]="isViewMode ? 'View Teacher' : isEditMode ? 'Edit Teacher' : 'Add Teacher'"
  (close)="closeAddTeacherOffcanvas()">
  
  <app-teacher-form
    [isEditMode]="isEditMode"
    [isViewMode]="isViewMode"
    [teacherData]="selectedTeacher"
    [countries]="countries"
    [states]="states"
    [cities]="cities"
    [isLoadingCountries]="isLoadingCountries"
    [isLoadingStates]="isLoadingStates"
    [isLoadingCities]="isLoadingCities"
    (save)="onTeacherFormSave($event)"
    (cancel)="closeAddTeacherOffcanvas()"
    (validityChange)="onTeacherFormValidityChange($event)"
    (countryChange)="loadStatesByCountry($event)"
    (stateChange)="loadCitiesByState($event)"
  ></app-teacher-form>
  
  <!-- Footer Buttons -->
  <div slot="footer-buttons" class="footer-button-group">
    @if (!isViewMode) {
      <!-- Previous Button -->
      @if (currentFormStep > 1) {
        <button 
          class="btn-secondary" 
          (click)="teacherFormComponent.previousStep()"
          type="button">
          <i class="fa-solid fa-arrow-left"></i>
          Previous
        </button>
      }
      
      <!-- Cancel Button -->
      <button 
        class="btn-cancel" 
        (click)="closeAddTeacherOffcanvas()"
        type="button">
        Cancel
      </button>
      
      <!-- Next or Save Button -->
      @if (currentFormStep < totalFormSteps) {
        <button 
          class="btn-primary" 
          (click)="goToNextStepWithValidation()"
          type="button">
          Next
          <i class="fa-solid fa-arrow-right"></i>
        </button>
      } @else {
        <button 
          class="btn-primary" 
          (click)="saveTeacherWithValidation()"
          [disabled]="isLoadingTeachers"
          type="button">
          @if (isLoadingTeachers) {
            Saving...
          } @else {
            {{ isEditMode ? 'Update' : 'Save' }}
          }
        </button>
      }
    } @else {
      <button 
        class="btn-cancel" 
        (click)="closeAddTeacherOffcanvas()"
        type="button">
        Close
      </button>
    }
  </div>
</app-off-canvas-wrapper>
